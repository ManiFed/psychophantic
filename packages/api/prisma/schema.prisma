generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Users & Auth ============

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  username     String?  @unique
  passwordHash String   @map("password_hash")
  bio          String?
  avatarUrl    String?  @map("avatar_url")
  noRateLimit  Boolean  @default(false) @map("no_rate_limit")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  creditBalance       CreditBalance?
  creditTransactions  CreditTransaction[]
  stripeCustomer      StripeCustomer?
  agents              Agent[]
  conversations       Conversation[]
  agentTemplates      AgentTemplate[]
  arenaRoomsCreated   ArenaRoom[]          @relation("ArenaRoomsCreated")
  arenaParticipants   ArenaParticipant[]
  arenaInstructions   ArenaInstruction[]
  following           Follow[]             @relation("Following")
  followers           Follow[]             @relation("Followers")
  forumThreads        ForumThread[]
  forumPosts          ForumPost[]

  @@map("users")
}

model CreditBalance {
  userId               String   @id @map("user_id")
  freeCreditsCents     Int      @default(10) @map("free_credits_cents")
  purchasedCreditsCents Int     @default(0) @map("purchased_credits_cents")
  lastFreeReset        DateTime @default(now()) @map("last_free_reset")
  updatedAt            DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credit_balances")
}

model CreditTransaction {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  amountCents     Int      @map("amount_cents")
  transactionType String   @map("transaction_type")
  sourceType      String?  @map("source_type")
  referenceId     String?  @map("reference_id")
  description     String?
  balanceAfterCents Int    @map("balance_after_cents")
  createdAt       DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("credit_transactions")
}

model StripeCustomer {
  userId           String @id @map("user_id")
  stripeCustomerId String @unique @map("stripe_customer_id")
  createdAt        DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("stripe_customers")
}

// ============ Agents ============

model Agent {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String
  model        String
  role         String
  systemPrompt String?  @map("system_prompt")
  avatarColor  String   @default("#6366f1") @map("avatar_color")
  avatarUrl    String?  @map("avatar_url")
  isTemplate   Boolean  @default(false) @map("is_template")
  isPublic     Boolean  @default(false) @map("is_public")
  templateUses Int      @default(0) @map("template_uses")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user               User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  templates          AgentTemplate[]
  participants       ConversationParticipant[]
  messages           Message[]
  arenaParticipants  ArenaParticipant[]
  arenaInstructions  ArenaInstruction[]

  @@index([userId])
  @@index([isTemplate])
  @@map("agents")
}

model AgentTemplate {
  id            String   @id @default(uuid())
  sourceAgentId String?  @map("source_agent_id")
  creatorId     String   @map("creator_id")
  name          String
  model         String
  role          String
  systemPrompt  String?  @map("system_prompt")
  description   String?
  tags          String[]
  cloneCount    Int      @default(0) @map("clone_count")
  isPublic      Boolean  @default(true) @map("is_public")
  createdAt     DateTime @default(now()) @map("created_at")

  sourceAgent Agent? @relation(fields: [sourceAgentId], references: [id], onDelete: SetNull)
  creator     User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([tags])
  @@index([cloneCount(sort: Desc)])
  @@map("agent_templates")
}

// ============ Conversations ============

model Conversation {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  title                 String?
  mode                  String   // 'debate' | 'collaborate'
  status                String   @default("active") // 'active' | 'paused' | 'completed' | 'force_agreement'
  totalRounds           Int?     @map("total_rounds")
  currentRound          Int      @default(1) @map("current_round")
  forceAgreementState   Json?    @map("force_agreement_state")
  parentConversationId  String?  @map("parent_conversation_id")
  branchPointMessageId  String?  @map("branch_point_message_id")
  isPublic              Boolean  @default(false) @map("is_public")
  publicSlug            String?  @unique @map("public_slug")
  totalCostCents        Int      @default(0) @map("total_cost_cents")
  initialPrompt         String?  @map("initial_prompt")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user              User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentConversation Conversation?            @relation("ConversationBranches", fields: [parentConversationId], references: [id], onDelete: SetNull)
  branches          Conversation[]            @relation("ConversationBranches")
  participants      ConversationParticipant[]
  messages          Message[]
  coalitionEvents   CoalitionEvent[]
  arenaRoom         ArenaRoom?

  @@index([userId])
  @@index([publicSlug])
  @@map("conversations")
}

model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  agentId        String   @map("agent_id")
  turnOrder      Int      @map("turn_order")
  isActive       Boolean  @default(true) @map("is_active")
  nonNegotiables Json?    @map("non_negotiables")
  currentVote    String?  @map("current_vote") // 'approve' | 'reject' | null

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  agent        Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([conversationId, agentId])
  @@unique([conversationId, turnOrder])
  @@map("conversation_participants")
}

model Message {
  id              String   @id @default(uuid())
  conversationId  String   @map("conversation_id")
  agentId         String?  @map("agent_id")
  userId          String?  @map("user_id")
  content         String
  role            String   // 'agent' | 'user' | 'system' | 'synthesizer'
  roundNumber     Int?     @map("round_number")
  modelUsed       String?  @map("model_used")
  inputTokens     Int?     @map("input_tokens")
  outputTokens    Int?     @map("output_tokens")
  costCents       Int      @default(0) @map("cost_cents")
  generationTimeMs Int?    @map("generation_time_ms")
  messageType     String   @default("standard") @map("message_type") // 'standard' | 'non_negotiables' | 'synthesis' | 'vote' | 'revision' | 'forced_resolution'
  createdAt       DateTime @default(now()) @map("created_at")

  conversation Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  agent        Agent?            @relation(fields: [agentId], references: [id], onDelete: SetNull)
  coalitionEvents CoalitionEvent[]

  @@index([conversationId, createdAt])
  @@index([agentId])
  @@map("messages")
}

model CoalitionEvent {
  id                 String   @id @default(uuid())
  conversationId     String   @map("conversation_id")
  detectedAtMessageId String  @map("detected_at_message_id")
  agentIds           String[] @map("agent_ids")
  agreementTopic     String?  @map("agreement_topic")
  confidenceScore    Decimal? @map("confidence_score") @db.Decimal(3, 2)
  createdAt          DateTime @default(now()) @map("created_at")

  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  detectedAtMessage Message     @relation(fields: [detectedAtMessageId], references: [id], onDelete: Cascade)

  @@map("coalition_events")
}

// ============ Arena ============

model ArenaRoom {
  id               String   @id @default(uuid())
  title            String
  topic            String
  status           String   @default("waiting") // 'waiting' | 'active' | 'completed' | 'cancelled'
  maxParticipants  Int      @default(2) @map("max_participants")
  totalRounds      Int      @default(3) @map("total_rounds")
  createdById      String   @map("created_by_id")
  conversationId   String?  @unique @map("conversation_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  createdBy      User          @relation("ArenaRoomsCreated", fields: [createdById], references: [id], onDelete: Cascade)
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  participants   ArenaParticipant[]
  instructions   ArenaInstruction[]

  @@index([status])
  @@index([createdById])
  @@map("arena_rooms")
}

model ArenaParticipant {
  id          String   @id @default(uuid())
  arenaRoomId String   @map("arena_room_id")
  userId      String   @map("user_id")
  agentId     String   @map("agent_id")
  isReady     Boolean  @default(false) @map("is_ready")
  joinedAt    DateTime @default(now()) @map("joined_at")

  arenaRoom ArenaRoom @relation(fields: [arenaRoomId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent     Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([arenaRoomId, userId])
  @@unique([arenaRoomId, agentId])
  @@map("arena_participants")
}

model ArenaInstruction {
  id          String   @id @default(uuid())
  arenaRoomId String   @map("arena_room_id")
  userId      String   @map("user_id")
  agentId     String   @map("agent_id")
  content     String
  roundNumber Int?     @map("round_number")
  applied     Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  arenaRoom ArenaRoom @relation(fields: [arenaRoomId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent     Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([arenaRoomId, agentId, applied])
  @@map("arena_instructions")
}

// ============ Social ============

model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  follower  User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

// ============ Forum ============

model ForumThread {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  content   String
  isPinned  Boolean  @default(false) @map("is_pinned")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts ForumPost[]

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("forum_threads")
}

model ForumPost {
  id        String   @id @default(uuid())
  threadId  String   @map("thread_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  thread ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([userId])
  @@map("forum_posts")
}

// ============ Exports ============

model Export {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  format         String    // 'pdf' | 'markdown'
  fileUrl        String?   @map("file_url")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@map("exports")
}
